name: Deploy newtodoapi API to EC2

on:
  push:
    branches: [ asiwome ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install -r todo/requirements.txt  # Adjust the path if requirements.txt is located elsewhere

      - name: Build the API (adjust for your build command)
        run: |
          cd todo  # Navigate to the directory containing manage.py
          # Optionally set STATIC_ROOT environment variable
          export STATIC_ROOT=/path/to/your/staticfiles  # Adjust the path according to your project structure
          python3 manage.py collectstatic --noinput  # Collect static files
          python3 manage.py migrate  # Apply migrations

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6  # Consider updating the action version if necessary
        with:
          host: ${{ secrets.EC2_HOST_IP }}
          username: ubuntu  # Adjust if using a different username
          key: ${{ secrets.PEM_KEY }}  # Encoded PEM key content
          script: |
            sudo apt-get update
            sudo apt-get install -y python3-pip  # Ensure python3 is available

            cd /var/newtodoapi  # Replace with your deployment directory
            git pull origin main

            # Install dependencies on EC2 instance
            pip3 install -r requirements.txt

            # Apply migrations (adjust as needed)
            python3 manage.py migrate

            # Collect static files (adjust as needed)
            python3 manage.py collectstatic --noinput

            # Restart your application process (adjust for your service manager)
            sudo systemctl restart gunicorn  # Example using gunicorn

      - name: (Optional) Clean up temporary files (use with caution!)
        run: |
          rm -rf /tmp/*
